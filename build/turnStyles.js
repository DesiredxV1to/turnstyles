!function(){var t,e,n=(t=function(t,e){t.exports={version:"5.3.0"}},function(n){return e||t(e={exports:{},parent:n},e.exports),e.exports});const i=function(){this.loadConfig(),this.loadThemes(),this.attachRoom()};(t=>{t.prototype.log=function(t){console.info("turnStyles :: "+t)},t.prototype.named=t=>{let e=window.turntable.topViewController.userMap[t];return e?e.attributes.name:"Someone"},t.prototype.buddy=t=>{let e=window.turntable.buddyList.pmWindows[t];return!!e&&e.otherUser.attributes.name},t.prototype.pinged=function(t){let e="@"+this.core.user.attributes.name.toLowerCase();return t.toLowerCase().indexOf(e)>-1},t.prototype.scaleVol=t=>Math.log(t/100)/Math.LN2+4,t.prototype.holding={},t.prototype.suspend=function(t,e,n){this.holding[n]?delete this.holding[n]:t&&t(),this.holding[n]=setTimeout((()=>{delete this.holding[n]}).bind(this),1e3*e)},t.prototype.click=function(t){$(window).focus();let e={bubbles:!0,cancelable:!0,view:window},n=document.querySelectorAll(t)[0],i=new MouseEvent("click",e);return!n.dispatchEvent(i)}})(i),(t=>{t.prototype.default={theme:"dark",style:"",autobop:!0,nextdj:!1,pingdj:!1,has_vol:!1,no_aud:!0,no_vid:!0,ping_pm:!1,ping_song:!1,ping_chat:!1,chat_song:!1,chat_spun:!1,chat_snag:!1,chat_join:!1,chat_left:!1},t.prototype.options={theme:{dark:"Dark Mode",night:"Night Mode"},style:{pink:"Pink",blue:"Blue",teal:"Teal",green:"Green",purple:"Purple"}},t.prototype.loadConfig=function(){this.buildCache(),this.chrome=!!window.tsBase,this.__base=window.tsBase||"https://ts.pixelcrisis.co/build";let t=window.localStorage.getItem("tsdb"),e=t?JSON.parse(t):{};this.config={...this.default,...e},this.log("loaded config")},t.prototype.saveConfig=function(t){let e="checkbox"==t.target.type,n=t.target.id.split("ts_").join(""),i=e?t.target.checked:t.target.value;$(`#ts_panel #${t.target.id}, #ts_window #${t.target.id}`).prop(e?"checked":"value",i),this.config[n]=i;let o=JSON.stringify(this.config);window.localStorage.setItem("tsdb",o),this.log("saved config"),this.handleSave(n)}})(i),(t=>{t.prototype.buildCache=function(){this.last_played||(this.last_played={}),this.now_playing||(this.now_playing={}),this.current_djs||(this.current_djs={})},t.prototype.cacheTrack=function(t,e=0){let n={...this.now_playing};if(this.last_played=n,this.now_playing=t?{...t.metadata,love:e,hate:0,snag:0,dj:t.djid}:{},!n.song)return!1;let i=this.current_djs[n.dj];return i||this.cacheNewDJ(n.dj,1),i.spun+=1,i.love+=n.love,i.hate+=n.hate,i.snag+=n.snag,`${n.love}\u2764\ufe0f${n.hate}\ud83d\udc94${n.snag}\ud83d\udc96`},t.prototype.cacheNewDJ=function(t,e=0){this.current_djs[t]||(this.current_djs[t]={spun:e,love:0,hate:0,snag:0})},t.prototype.clearOldDJ=function(t){if(!this.current_djs[t])return!1;let e={...this.current_djs[t],user:t};return delete this.current_djs[t.userid],`${e.love}\u2764\ufe0f${e.hate}\ud83d\udc94${e.snag}\ud83d\udc96${e.spun}\u25b6\ufe0f`}})(i),(t=>{t.prototype.handle=function(t){switch(t.command){case"pmmed":this.handlePmmed(t);break;case"speak":this.handleSpeak(t);break;case"nosong":this.handleTrack(t);break;case"add_dj":this.handleAddDJ(t);break;case"rem_dj":this.handleRemDJ(t);break;case"newsong":this.handleTrack(t);break;case"snagged":this.handleSteal(t);break;case"registered":this.handleJoins(t);break;case"deregistered":this.handleLeave(t);break;case"update_votes":this.handleVotes(t)}},t.prototype.handleLoad=function(){this.buildPanel(),this.runAutobop(),this.handleSave(),this.log("loaded room: "+this.room.roomId)},t.prototype.handleSave=function(t){let e=t&&"nextdj"==t,n=t&&"has_vol"==t,i=t&&"theme"==t||"style"==t,o=t&&0===t.indexOf("ping_");t&&!e||this.checkDecks(),t&&!i||this.loadThemes(),t&&!n||this.loadVolume(),t&&!o||this.notifyAuth(),$("body").toggleClass("ts_hide_audience",this.config.no_aud),$("body").toggleClass("ts_hide_videos",this.config.no_vid)},t.prototype.handlePmmed=function(t){if(this.config.ping_pm){let e=this.buddy(t.senderid),n=e?"New PM from: "+e:"New PM";this.notifyUser({head:n,text:t.text},"ping_pm")}},t.prototype.handleSpeak=function(t){if(this.pinged(t.text)){if(this.config.ping_chat){let e=`[${this.room.roomData.name}] @${t.name}`;this.notifyUser({head:e,text:t.text},"ping_chat")}this.holding.nextdj&&(this.log("nextdj: received ping"),this.tryJumping())}},t.prototype.handleTrack=function(t){let e=t.room.metadata.current_song,n=this.cacheTrack(e);if(this.mute&&this.toggleMute(),this.config.ping_song){let t="Now Playing: "+this.now_playing.song,e=n||"By: "+this.now_playing.artist;this.notifyUser({head:t,text:e})}if(this.config.chat_song&&n){let t=this.last_played;this.sendToChat(n,`${t.song} by ${t.artist}`,"stat")}this.runAutobop()},t.prototype.handleAddDJ=function(t){this.cacheNewDJ(t.user[0].userid),this.user==t.user[0].userid&&this.config.nextdj&&this.isSpinning()},t.prototype.handleRemDJ=function(t){if(this.checkDecks(),this.config.chat_spun){let e=t.user[0].name,n="- is done spinning!",i=this.clearOldDJ(t.user[0].userid);this.sendToChat(`${e} - ${i}`,n,"stat")}},t.prototype.handleSteal=function(t){if(this.now_playing.snag+=1,this.config.chat_snag){let e=this.named(t.userid),n="has snagged this track!";this.sendToChat(e,n,"snag")}},t.prototype.handleVotes=function(t){this.now_playing.love=t.room.metadata.upvotes,this.now_playing.hate=t.room.metadata.downvotes},t.prototype.handleJoins=function(t){if(this.config.chat_join){let e=t.user[0].name;this.sendToChat(e,"joined.","join")}},t.prototype.handleLeave=function(t){if(this.config.chat_left){let e=t.user[0].name;this.sendToChat(e,"left.","left")}}})(i),(t=>{t.prototype.countSongs=()=>{let t=$("#playlist-header .text")[0],e=window.turntable.playlist.fileids.length,n=t.innerHTML.split("<em>")[0];t.innerHTML=`${n} <em>${e}</em>`}})(i),(t=>{t.prototype.loadThemes=function(){$("link.tS-core").length||this.createLink("turnStyles"),this.refreshURL(this.config.theme,"themes"),this.refreshURL(this.config.style,"styles"),this.hideUpload(),this.log("refreshed themes")},t.prototype.hideUpload=function(){let t=$("#ts_upload");this.config.theme&&!t.length?($("#upload-button").after('<div id="ts_upload"></div>'),$("#ts_upload").on("click",this.fakeUpload.bind(this))):!this.config.theme&&t.length&&t.remove()},t.prototype.fakeUpload=function(){$("#queue-header").removeClass("normal").addClass("edit");let t=this.core.playlist;t.isFiltering&&t.clearSearchBar(),t.queue.batchEditMode()},t.prototype.locatePath=function(t,e){return`${e?`${this.__base}/${e}`:""+this.__base}/${t}.css`},t.prototype.refreshURL=function(t,e){let n=$("link.tS-"+(e||"core"));if(!t)return!!n.length&&n.remove();n.length?n.attr("href",this.locatePath(t,e)):this.createLink(t,e)},t.prototype.createLink=function(t,e){let n=e||"core",i=document.createElement("link");i.classList.add("tS-"+n),i.rel="stylesheet",i.type="text/css",i.href=this.locatePath(t,e),document.head.append(i)}})(i),(t=>{t.prototype.attachRoom=function(){if(!window.turntable)return this.log("no room");let n=()=>setTimeout(t.prototype.attachRoom.bind(this),250);if(this.core=window.turntable,!this.core.user)return n();if(this.user=this.core.user.id,this.view=this.core.topViewController,this.room=e(this.core,"roomId"),!this.room)return n();if(this.ttfm=e(this.room,"roomData"),!this.ttfm)return n();this.cacheTrack(this.room.currentSong,this.room.upvoters.length);for(let t of this.room.djids)this.cacheNewDJ(t);this.realVolume=window.turntablePlayer.realVolume,this.countSongs(),$("#songs-wrapper").on("DOMSubtreeModified","#songs",this.countSongs),this.core.addEventListener("message",this.handle.bind(this)),this.handleLoad()};const e=function(t,e){for(let n in t){let i=t[n];if(null!=i&&i[e])return i}}})(i),(t=>{const e=n({}).version;t.prototype.buildPanel=function(){$(".header-bar").append(o(this)),$("#ts_tabs div").on("click",i),$(".ts_menu").on("click",()=>$("#ts_hotbar, #ts_window").toggleClass("active")),$("#ts_hotbar input, #ts_window input, #ts_window select").on("change",this.saveConfig.bind(this))};const i=t=>{$("#ts_tabs div, .ts_tab").removeClass("active"),$("."+t.currentTarget.className).addClass("active")},o=t=>`\n    <div id="ts_hotbar">\n      <h3 class="ts_menu">\u2630 tS</h3>\n      ${s(t,"autobop","Autobop")}\n      ${a(t,["nextdj","pingdj"],["Next DJ Spot","On Ping"])}\n    </div>\n    <div id="ts_window">\n      <h3 class="ts_menu">\u2630 turnStyles</h3>\n      <div id="ts_tabs">\n        <div class="tab_opts active">Options</div>\n        <div class="tab_ui">Visual</div>\n        <div class="tab_chat">In Chat</div>\n        <div class="tab_ding">Notify</div>\n      </div>\n      <div class="ts_tab tab_opts active">\n        <h4>General Features</h4> \n        ${s(t,"autobop","Autobop")}\n        ${s(t,"has_vol","Control Volume")}\n        <br>\n        ${a(t,["nextdj","pingdj"],["Next DJ Spot","Wait For Ping"])}\n      </div>\n      <div class="ts_tab tab_ui">\n        <h4>Visual Options</h4>\n        ${h(t,"theme")}\n        ${h(t,"style")}\n        <br>\n        ${s(t,"no_aud","Hide Audience")}\n        ${s(t,"no_vid","Hide Player")}\n      </div>\n      <div class="ts_tab tab_chat">\n        <h4>Post Messages In Chat</h4>\n        ${s(t,"chat_song","Last Song Stats")}\n        ${s(t,"chat_spun","Dropped DJ Stats")}\n        <br>\n        ${s(t,"chat_snag","User Snags")}\n        ${s(t,"chat_join","User Joins")}\n        ${s(t,"chat_left","User Leaves")}\n      </div>\n      <div class="ts_tab tab_ding">\n        <h4>Send Desktop Notifications</h4>\n        ${s(t,"ping_pm","On DMs")}\n        ${s(t,"ping_chat","On Mentions")}\n        ${s(t,"ping_song","On New Songs")}\n      </div>\n      <div class="ts_credits">\n        <small class="ts_menu">\u2714\ufe0e CLOSE</small>\n        <small>v${e}</small>\n        <small>\n          <a href="https://discord.gg/jnRs4WnPjM" target="_blank">\n            Join me on the TT Discord\n          </a>\n        </small>\n      </div>\n    </div>\n  `,s=(t,e,n)=>`\n    <label class="ts_toggle">\n      <input id="ts_${e}" type="checkbox"\n        ${t.config[e]?"checked":""}>\n      </input>\n      ${n}\n    </label>\n  `,a=(t,e,n)=>{let i='<label class="ts_toggle">';for(var o=0;o<e.length;o++)i+=`\n      <input id="ts_${e[o]}" type="checkbox"\n        ${t.config[e[0]]?"checked":""}>\n      </input>\n      ${n[o]}\n      ${o<e.length-1?"<span>|</span>":""}\n    `;return i+"</label>"},h=(t,e)=>`\n    <select id="ts_${e}">\n      <option value="">No ${e[0].toUpperCase()+e.substring(1)}</option>\n      ${Object.keys(t.options[e]).map(n=>`\n        <option value="${n}" ${t.config[e]==n?"selected":""}>\n          ${t.options[e][n]}\n        </option>\n      `).join("")}\n    </select>\n  `})(i),(t=>{t.prototype.loadVolume=function(){let t=$("body").hasClass("has-volume");if($("body").toggleClass("has-volume",!t),this.config.has_vol&&!t){$(".header-content").append(e(this));let t=$("#ts_mute"),n=$("#ts_slider");t.on("click",this.toggleMute.bind(this)),n.on("input",this.saveVolume.bind(this)),n.on("DOMMouseScroll mousewheel",this.onVolWheel.bind(this))}else!this.config.has_vol&&t&&($("#ts_volume").remove(),window.turntablePlayer.realVolume=this.realVolume)},t.prototype.currVolume=function(t){let e=t||window.util.getSetting("volume");return 100*Math.pow(2,e-4)},t.prototype.saveVolume=function(t){let e=(t=t.target?t.target.value:t)>0?this.scaleVol(t):-3;window.turntablePlayer.realVolume=e>6?this.realVolume:this.currVolume,window.turntablePlayer.setVolume(e),window.util.setSetting("volume",e)},t.prototype.toggleMute=function(){this.mute=!this.mute,$("#ts_volume").toggleClass("muted",this.mute),window.turntablePlayer.setVolume(this.mute?-3:this.scaleVol(this.currVolume())),this.log("turned mute "+(this.mute?"on":"off"))},t.prototype.onVolWheel=function(t){const e=this.currVolume();let n=t.originalEvent.shiftKey?1:5,i=t.originalEvent.deltaY>0?e-n:e+n;return i=i<0?0:i>100?100:i,$("#ts_slider")[0].value=i,this.saveVolume(i),!1};const e=t=>`\n    <div id="ts_volume">\n      <span id="ts_mute"></span>\n      <input id="ts_slider" type="range" \n        min="0" max="100" value="${t.currVolume()}">\n      </input>\n      <em id="ts_muted">Muted For One Song</em>\n    </div>\n    `})(i),(t=>{t.prototype.runAutobop=function(){if(this.autobop&&clearTimeout(this.autobop),!this.config.autobop)return;let t=7*Math.random()*100;this.autobop=setTimeout((()=>this.click(".awesome-button")).bind(this),t)}})(i),(t=>{t.prototype.checkDecks=function(){this.config.nextdj&&(this.config.pingdj?this.suspend(null,2,"nextdj"):this.tryJumping())},t.prototype.tryJumping=function(){if(!$(".become-dj").length)return this.log("nextdj: no spot");this.log("nextdj: taking spot"),this.room.becomeDj()},t.prototype.isSpinning=function(){$("#ts_pane").removeClass("active"),this.config.nextdj=!1,$("#ts_nextdj").prop("checked",!1),setTimeout(this.saveConfig.bind(this),5e3),this.notifyUser({head:"You've Hopped On Deck!",text:"NextDJ is now disabled."})}})(i),(t=>{t.prototype.notifyAuth=function(){let t=this.config;return!(!(t.ping_chat||t.ping_pm||t.ping_song)||this.chrome||!("Notification"in window)||"denied"===Notification.permission||"default"===Notification.permission&&(Notification.requestPermission(),this.log("requesting notification permission"),1))},t.prototype.notifyUser=function(t,e){if(document.hasFocus())return;let i=n(this,t),o=()=>{window.postMessage(i)};if(!this.chrome){if(!this.notifyAuth())return;o=()=>{const e=new Notification(t.head,i);e.onclick=()=>{window.focus(),e.close()}}}return e?this.suspend(o,10,e):o()},t.prototype.sendToChat=function(t,n,i){$(".chat .messages").append(e(t,n,i)),this.view.updateChatScroll()};const e=(t,e,n="")=>`\n    <div class="message ${n}">\n      <em>\n        <span class="subject">${t}</span>\n        <span class="text">${e}</span>\n      </em>\n    </div>\n  `,n=(t,e)=>t.chrome?{type:"tsNotify",notification:e}:{icon:"https://ts.pixelcrisis.co/build/images/icon128.png",body:e.text}})(i),window.$tS=new i}();